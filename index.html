<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>·ª®ng D·ª•ng T·∫°o Ma Tr·∫≠n ƒê·ªÅ Ki·ªÉm Tra</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Add mammoth.js for DOCX parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<!-- Firebase SDKs - ƒê√É X√ìA T·ª™ ƒê√ÇY, CHUY·ªÇN SANG IMPORT TRONG MODULE -->

<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    primary: '#5D5CDE',
                    light: '#FFFFFF',
                    dark: '#181818'
                }
            }
        }
    }
</script>
<style>
    .btn-primary {
        @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors duration-200 text-base font-medium shadow-md;
    }
    .btn-secondary {
        @apply bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-200 text-base font-medium shadow-md;
    }
    .btn-outline {
        @apply border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 text-base font-medium;
    }
    .btn-danger {
        @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 text-base font-medium shadow-md;
    }
    .btn-primary:disabled, .btn-secondary:disabled, .btn-outline:disabled, .btn-danger:disabled {
        @apply opacity-50 cursor-not-allowed;
    }
    
    .matrix-cell {
        transition: all 0.2s ease;
        border: 2px solid #e5e7eb;
    }
    .matrix-cell:hover {
        border-color: #5D5CDE;
        background-color: #f8fafc;
    }
    .dark .matrix-cell:hover {
        background-color: #374151;
    }
    .matrix-cell.filled {
        background-color: #eff6ff;
        border-color: #3b82f6;
    }
    .dark .matrix-cell.filled {
        background-color: #1e3a8a;
        border-color: #60a5fa;
    }
    .modal-overlay {
        backdrop-filter: blur(4px);
    }
    /* Custom scrollbar for specification library */
    #specificationModalBody::-webkit-scrollbar, #firebaseMatrixList::-webkit-scrollbar {
        width: 8px;
    }
    #specificationModalBody::-webkit-scrollbar-track, #firebaseMatrixList::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .dark #specificationModalBody::-webkit-scrollbar-track, .dark #firebaseMatrixList::-webkit-scrollbar-track {
        background: #2d3748;
    }
    #specificationModalBody::-webkit-scrollbar-thumb, #firebaseMatrixList::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    #specificationModalBody::-webkit-scrollbar-thumb:hover, #firebaseMatrixList::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
</head>
<body class="bg-light dark:bg-dark text-gray-900 dark:text-gray-100 transition-colors duration-300">
<!-- Header -->
<header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-center text-primary">
            <i class="fas fa-th-large mr-2"></i>
            ·ª®ng D·ª•ng T·∫°o Ma Tr·∫≠n ƒê·ªÅ Ki·ªÉm Tra
        </h1>
        <p class="text-center text-gray-600 dark:text-gray-400 mt-2">
            T·∫°o ma tr·∫≠n ƒë·ªÅ ki·ªÉm tra v√† sinh c√¢u h·ªèi t·ª± ƒë·ªông b·∫±ng AI-TG: T√¨a Qu·ªëc Th·∫Øng
        </p>
    </div>
</header>

<main class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Control Panel -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="showTopicModal()" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>Th√™m Ch·ªß ƒë·ªÅ
            </button>
            <button onclick="showScoreModal()" class="btn-outline">
                <i class="fas fa-cog mr-2"></i>Thi·∫øt L·∫≠p ƒêi·ªÉm S·ªë
            </button>
            <button onclick="generateAITest()" class="btn-secondary">
                <i class="fas fa-magic mr-2"></i>T·∫°o ƒê·ªÅ Thi B·∫±ng AI
            </button>
            <button onclick="exportMatrix()" class="btn-outline">
                <i class="fas fa-download mr-2"></i>Xu·∫•t Ma Tr·∫≠n
            </button>
            <button onclick="exportExcel()" class="btn-outline">
                <i class="fas fa-file-excel mr-2"></i>Xu·∫•t Excel
            </button>
            <button onclick="importMatrix()" class="btn-outline">
                <i class="fas fa-upload mr-2"></i>Nh·∫≠p Ma Tr·∫≠n
            </button>
            <!-- Firebase Buttons -->
            <button onclick="showSaveFirebaseModal()" class="btn-outline" id="btn-save-firebase">
                <i class="fas fa-cloud-upload-alt mr-2"></i>L∆∞u l√™n Cloud
            </button>
            <button onclick="openLoadFirebaseModal()" class="btn-outline" id="btn-load-firebase">
                <i class="fas fa-cloud-download-alt mr-2"></i>M·ªü t·ª´ Cloud
            </button>
            <!-- End Firebase Buttons -->
            <button onclick="clearAll()" class="btn-danger">
                <i class="fas fa-trash mr-2"></i>X√≥a T·∫•t C·∫£
            </button>
        </div>
    </div>

    <!-- Topics Management -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-list mr-2"></i>Qu·∫£n l√Ω Ch·ªß ƒë·ªÅ
        </h2>
        <div id="topicsList" class="flex flex-wrap gap-2">
            <!-- Topics will be displayed here -->
        </div>
    </div>

    <!-- Matrix Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-table mr-2"></i>Ma Tr·∫≠n ƒê·ªÅ
        </h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
            Nh·∫•p v√†o √¥ trong ma tr·∫≠n ƒë·ªÉ xem chi ti·∫øt y√™u c·∫ßu c·∫ßn ƒë·∫°t.
        </p>
        <div class="overflow-x-auto">
            <div id="matrixContainer" class="min-w-full">
                <div id="matrixGrid" class="grid gap-2">
                    <!-- Matrix will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-chart-bar mr-2"></i>B·∫£ng T·ªïng K·∫øt
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                <tr class="bg-gray-50 dark:bg-gray-700">
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">Ch·ªß ƒë·ªÅ</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        Nh·∫≠n bi·∫øt<br>
                        <span id="knowledgePercent" class="text-xs text-gray-500 dark:text-gray-400">(40%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        Th√¥ng hi·ªÉu<br>
                        <span id="comprehensionPercent" class="text-xs text-gray-500 dark:text-gray-400">(40%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        V·∫≠n d·ª•ng<br>
                        <span id="applicationPercent" class="text-xs text-gray-500 dark:text-gray-400">(20%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">T·ªïng</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">ƒêi·ªÉm</th>
                </tr>
                </thead>
                <tbody id="summaryTableBody">
                <!-- Summary data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Topic Modal -->
<div id="topicModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Th√™m Ch·ªß ƒë·ªÅ m·ªõi</h3>
            <button onclick="closeTopicModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <input type="text" id="topicNameInput" placeholder="T√™n ch·ªß ƒë·ªÅ"
               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        <div class="flex justify-end mt-4 space-x-2">
            <button onclick="closeTopicModal()" class="btn-outline">H·ªßy</button>
            <button onclick="addTopic()" class="btn-primary">L∆∞u Ch·ªß ƒë·ªÅ</button>
        </div>
    </div>
</div>

    <!-- Cell Detail Modal -->
<div id="cellModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 id="cellModalTitle" class="text-lg font-bold">Chi ti·∫øt √¥ ma tr·∫≠n</h3>
            <button onclick="closeCellModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4 mb-4">
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-list mr-1"></i>Tr·∫Øc nghi·ªám 4 ƒë√°p √°n:
                </label>
                <input type="number" id="multipleChoiceCount" min="0" max="20" oninput="updateTotalQuestionsInModal()"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-check-square mr-1"></i>C√¢u ƒë√∫ng/sai (1 c√¢u = 4 √Ω):
                </label>
                <input type="number" id="trueFalseCount" min="0" max="10" oninput="updateTotalQuestionsInModal()"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-edit mr-1"></i>C√¢u t·ª± lu·∫≠n:
                </label>
                <input type="number" id="essayCount" min="0" max="10" oninput="updateTotalQuestionsInModal()"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-md">
                <div class="text-sm text-blue-700 dark:text-blue-300">
                    <p><strong>T·ªïng c√¢u h·ªèi:</strong> <span id="totalQuestions">0</span> c√¢u</p>
                    <p><strong>T·ªïng ƒëi·ªÉm:</strong> <span id="totalScore">0</span> ƒëi·ªÉm</p>
                </div>
            </div>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">
                <i class="fas fa-map-marker-alt mr-1"></i>V·ªã tr√≠ c√¢u h·ªèi trong ƒë·ªÅ:
            </label>
            <input type="text" id="questionPosition" placeholder="VD: C√¢u 1-5, C√¢u I.1-I.3, Ph·∫ßn A..."
                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        </div>
        
        <!-- Specification Library Button and Notes Textarea -->
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Ghi ch√∫ (Y√™u c·∫ßu c·∫ßn ƒë·∫°t):</label>
            <button onclick="openSpecificationModal()" class="btn-secondary w-full mb-2">
                <i class="fas fa-book mr-2"></i>Ch·ªçn t·ª´ Th∆∞ vi·ªán ƒê·∫∑c t·∫£
            </button>
            <textarea id="cellNotes" rows="4" placeholder="M√¥ t·∫£ y√™u c·∫ßu, n·ªôi dung c·∫ßn ki·ªÉm tra... ho·∫∑c ch·ªçn t·ª´ th∆∞ vi·ªán"
                      class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"></textarea>
        </div>

        <div class="flex justify-end space-x-2">
            <button onclick="closeCellModal()" class="btn-outline">H·ªßy</button>
            <button onclick="saveCellData()" class="btn-primary">L∆∞u</button>
        </div>
    </div>
</div>

<!-- AI Test Generation Modal -->
<div id="aiModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
                <i class="fas fa-magic mr-2"></i>ƒê·ªÅ Thi & ƒê√°p √Ån Do AI T·∫°o
            </h3>
            <button onclick="closeAIModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="aiLoadingState" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400">AI ƒëang s√°ng t·∫°o c√¢u h·ªèi v√† ƒë√°p √°n... Vui l√≤ng ch·ªù trong gi√¢y l√°t.</p>
        </div>
        <div id="aiContent" class="hidden">
            <div id="aiGeneratedTest" class="prose dark:prose-invert max-w-none mb-4">
                <!-- AI generated content will appear here -->
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="regenerateTest()" class="btn-outline">
                    <i class="fas fa-redo mr-2"></i>T·∫°o l·∫°i
                </button>
                <button onclick="exportTest()" class="btn-primary">
                    <i class="fas fa-download mr-2"></i>Xu·∫•t ƒê·ªÅ & ƒê√°p √°n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Score Settings Modal -->
<div id="scoreModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
                <i class="fas fa-cog mr-2"></i>Thi·∫øt L·∫≠p ƒêi·ªÉm S·ªë
            </h3>
            <button onclick="closeScoreModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-blue-800 dark:text-blue-200">
                    <i class="fas fa-calculator mr-2"></i>ƒêi·ªÉm s·ªë m·ªói lo·∫°i c√¢u h·ªèi
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tr·∫Øc nghi·ªám 4 ƒë√°p √°n:</label>
                        <input type="number" id="scoreMultipleChoice" step="0.25" min="0" max="10" value="0.25" oninput="updateScoreCalculationInModal()"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">ƒëi·ªÉm</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">ƒê√∫ng/Sai (4 √Ω):</label>
                        <input type="number" id="scoreTrueFalse" step="0.25" min="0" max="10" value="1" oninput="updateScoreCalculationInModal()"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">ƒëi·ªÉm</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">T·ª± lu·∫≠n:</label>
                        <input type="number" id="scoreEssay" step="0.25" min="0" max="10" value="1.0" oninput="updateScoreCalculationInModal()"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">ƒëi·ªÉm</span>
                    </div>
                </div>
            </div>

            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-green-800 dark:text-green-200">
                    <i class="fas fa-percentage mr-2"></i>T·ªâ l·ªá m·ª©c ƒë·ªô mong mu·ªën (%)
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nh·∫≠n bi·∫øt:</label>
                        <input type="number" id="percentKnowledge" min="0" max="100" value="40" oninput="updatePercentageTotalInModal()"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Th√¥ng hi·ªÉu:</label>
                        <input type="number" id="percentComprehension" min="0" max="100" value="30" oninput="updatePercentageTotalInModal()"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">V·∫≠n d·ª•ng:</label>
                        <input type="number" id="percentApplication" min="0" max="100" value="30" oninput="updatePercentageTotalInModal()"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                </div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <span id="totalPercent">T·ªïng: 100%</span>
                </div>
            </div>

            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-purple-800 dark:text-purple-200">
                    <i class="fas fa-info-circle mr-2"></i>Th√¥ng tin t·ªïng ƒëi·ªÉm
                </h4>
                <div id="scoreCalculation" class="text-sm space-y-1">
                    <!-- Score calculation will be displayed here -->
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6 space-x-2">
            <button onclick="closeScoreModal()" class="btn-outline">H·ªßy</button>
            <button onclick="saveScoreSettings()" class="btn-primary">L∆∞u Thi·∫øt L·∫≠p</button>
        </div>
    </div>
</div>

<!-- Specification Library Modal -->
<div id="specificationModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 flex flex-col" style="height: 80vh;">
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
            <h3 class="text-lg font-bold"><i class="fas fa-book mr-2"></i>Th∆∞ vi·ªán ƒê·∫∑c t·∫£ (Y√™u c·∫ßu c·∫ßn ƒë·∫°t)</h3>
            <button onclick="closeSpecificationModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex flex-wrap gap-2 mb-4 flex-shrink-0">
            <input type="text" id="specificationSearch" onkeyup="searchSpecifications()" placeholder="T√¨m ki·∫øm y√™u c·∫ßu..." class="flex-grow px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            <button onclick="importFromDocx()" class="btn-primary">
                <i class="fas fa-file-word mr-2"></i>Nh·∫≠p t·ª´ DOCX
            </button>
            <button onclick="clearLibrary()" class="btn-danger">
                <i class="fas fa-trash-alt mr-2"></i>X√≥a th∆∞ vi·ªán
            </button>
        </div>

        <div id="specificationModalBody" class="overflow-y-auto flex-grow pr-2">
            <ul id="specificationList" class="space-y-2">
                <!-- Library items will be populated here -->
            </ul>
        </div>

        <div class="flex justify-end mt-4 space-x-2 flex-shrink-0">
            <button onclick="closeSpecificationModal()" class="btn-outline">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                <i class="fas fa-check text-2xl text-green-600 dark:text-green-400"></i>
            </div>
            <h3 class="text-lg font-bold mb-2">Th√†nh c√¥ng!</h3>
            <p id="successMessage" class="text-gray-600 dark:text-gray-400 mb-4"></p>
            <button onclick="closeSuccessModal()" class="btn-primary">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Save Firebase Modal -->
<div id="saveFirebaseModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold"><i class="fas fa-cloud-upload-alt mr-2"></i>L∆∞u Ma Tr·∫≠n l√™n Cloud</h3>
            <button onclick="closeSaveFirebaseModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <label for="matrixNameInput" class="block text-sm font-medium mb-2">T√™n Ma Tr·∫≠n:</label>
        <input type="text" id="matrixNameInput" placeholder="VD: Ma tr·∫≠n ki·ªÉm tra gi·ªØa k·ª≥ 1"
               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        <div class="flex justify-end mt-4 space-x-2">
            <button onclick="closeSaveFirebaseModal()" class="btn-outline">H·ªßy</button>
            <button onclick="saveMatrixToFirebase()" id="saveFirebaseBtn" class="btn-primary">L∆∞u</button>
        </div>
    </div>
</div>

<!-- Load Firebase Modal -->
<div id="loadFirebaseModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 flex flex-col" style="height: 80vh;">
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
            <h3 class="text-lg font-bold"><i class="fas fa-cloud-download-alt mr-2"></i>M·ªü Ma Tr·∫≠n t·ª´ Cloud</h3>
            <button onclick="closeLoadFirebaseModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="firebaseMatrixList" class="overflow-y-auto flex-grow pr-2 space-y-3">
            <!-- List of saved matrices will appear here -->
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin text-2xl text-primary"></i>
                <p class="mt-2">ƒêang t·∫£i danh s√°ch ma tr·∫≠n...</p>
            </div>
        </div>

        <div class="flex justify-end mt-4 space-x-2 flex-shrink-0">
            <button onclick="closeLoadFirebaseModal()" class="btn-outline">ƒê√≥ng</button>
        </div>
    </div>
</div>


    <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // == ADMIN CONFIG ==
    // Th√™m UID c·ªßa admin v√†o danh s√°ch n√†y. 
    // UID c√≥ th·ªÉ t√¨m th·∫•y ·ªü ph·∫ßn "L∆∞u b·ªüi:" khi m·ªü ma tr·∫≠n t·ª´ Cloud.
    const ADMIN_USER_IDS = ["02203480527462705609", "GxU4WElTDfSDtqZqBzdg40kX8s42"];
    // ================

    // Dark mode setup
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
    } else {
        document.documentElement.classList.remove('dark')
    }

    // Global state
    let topics = ['Ch·ªß ƒë·ªÅ 1', 'Ch·ªß ƒë·ªÅ 2', 'Ch·ªß ƒë·ªÅ 3'];
    let taxonomyLevels = ['Nh·∫≠n bi·∫øt', 'Th√¥ng hi·ªÉu', 'V·∫≠n d·ª•ng', 'V·∫≠n d·ª•ng cao'];
    let matrixData = {};
    let currentCell = null;
    let specificationLibrary = [];

    // Score settings with default values
    let scoreSettings = {
        multipleChoice: 0.25,
        trueFalse: 1,
        essay: 1.0,
        percentages: {
            'Nh·∫≠n bi·∫øt': 40,
            'Th√¥ng hi·ªÉu': 30,
            'V·∫≠n d·ª•ng': 30,
            'V·∫≠n d·ª•ng cao': 0, // Added for completeness
        }
    };

    // Firebase state
    let app, db, auth, userId, isAuthReady = false;
    let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let firebaseConfig;

    // Firebase function references - ƒê√É X√ìA C√ÅC D√íNG G√ÇY L·ªñI
    // const { initializeApp } = firebase.app; // L·ªói: firebase is not defined
    // const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebase.auth; // L·ªói
    // const { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel } = firebase.firestore; // L·ªói


    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        initFirebaseAuth(); // Initialize Firebase
        loadSpecificationLibrary();
        renderTopics();
        renderMatrix();
        updateSummaryTable();
        
        // Event listeners
        ['multipleChoiceCount', 'trueFalseCount', 'essayCount'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateTotalQuestionsInModal);
        });
        ['scoreMultipleChoice', 'scoreTrueFalse', 'scoreEssay'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateScoreCalculationInModal);
        });
        ['percentKnowledge', 'percentComprehension', 'percentApplication'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePercentageTotalInModal);
        });
    });

    // --- Firebase Functions ---
    async function initFirebaseAuth() {
        // C·∫•u h√¨nh Firebase do ng∆∞·ªùi d√πng cung c·∫•p
        const userFirebaseConfig = {
          apiKey: "AIzaSyAnI3ACGmUYMxa-Yybu4EOWSrU_hBUtytg",
          authDomain: "matrixv11.firebaseapp.com",
          projectId: "matrixv11",
          storageBucket: "matrixv11.firebasestorage.app",
          messagingSenderId: "522250262725",
          appId: "1:522250262725:web:e57252ccdc1a215935f8ac"
        };

        // ∆Øu ti√™n s·ª≠ d·ª•ng config t·ª´ m√¥i tr∆∞·ªùng (__firebase_config) n·∫øu c√≥
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log('ƒêang s·ª≠ d·ª•ng c·∫•u h√¨nh Firebase t·ª´ m√¥i tr∆∞·ªùng.');
            } catch (err) {
                 console.error('L·ªói ph√¢n t√≠ch c√∫ ph√°p c·∫•u h√¨nh Firebase t·ª´ m√¥i tr∆∞·ªùng, chuy·ªÉn sang c·∫•u h√¨nh do ng∆∞·ªùi d√πng cung c·∫•p.', err);
                 firebaseConfig = userFirebaseConfig;
            }
        } else {
             console.log('ƒêang s·ª≠ d·ª•ng c·∫•u h√¨nh Firebase do ng∆∞·ªùi d√πng cung c·∫•p.');
            firebaseConfig = userFirebaseConfig;
        }

        // Ti·∫øp t·ª•c kh·ªüi t·∫°o Firebase n·∫øu c√≥ c·∫•u h√¨nh
        if (firebaseConfig) {
             try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // B·∫≠t ghi log Firestore

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log('Firebase ƒë√£ x√°c th·ª±c. User ID:', userId);
                        // K√≠ch ho·∫°t c√°c n√∫t Cloud khi ƒë√£ s·∫µn s√†ng
                        document.getElementById('btn-save-firebase').disabled = false;
                        document.getElementById('btn-load-firebase').disabled = false;
                    } else {
                        // Ch∆∞a ƒëƒÉng nh·∫≠p, th·ª≠ ƒëƒÉng nh·∫≠p
                        console.log('Kh√¥ng c√≥ ng∆∞·ªùi d√πng, ƒëang th·ª≠ ƒëƒÉng nh·∫≠p...');
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // onAuthStateChanged s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c g·ªçi l·∫°i sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng
                        } catch (err) {
                            console.error('L·ªói x√°c th·ª±c Firebase:', err);
                            isAuthReady = false;
                            disableCloudButtons('L·ªói x√°c th·ª±c. T√≠nh nƒÉng Cloud b·ªã t·∫Øt.');
                        }
                    }
                });
            } catch (err) {
                 console.error('L·ªói kh·ªüi t·∫°o Firebase:', err);
                 disableCloudButtons('L·ªói kh·ªüi t·∫°o Firebase. T√≠nh nƒÉng Cloud b·ªã t·∫Øt.');
            }
        } else {
            console.warn('Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh Firebase. T√≠nh nƒÉng Cloud b·ªã t·∫Øt.');
            disableCloudButtons('Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh. T√≠nh nƒÉng Cloud b·ªã t·∫Øt.');
        }
    }
    
    function disableCloudButtons(title) {
         document.querySelectorAll('#btn-save-firebase, #btn-load-firebase').forEach(btn => {
            btn.disabled = true;
            btn.title = title;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    }

    function showSaveFirebaseModal() {
        if (!isAuthReady) {
            showAlert('Ch∆∞a s·∫µn s√†ng k·∫øt n·ªëi Cloud. Vui l√≤ng ƒë·ª£i m·ªôt l√°t v√† th·ª≠ l·∫°i.');
            return;
        }
        document.getElementById('matrixNameInput').value = '';
        document.getElementById('saveFirebaseModal').classList.remove('hidden');
        document.getElementById('matrixNameInput').focus();
    }

    function closeSaveFirebaseModal() {
        document.getElementById('saveFirebaseModal').classList.add('hidden');
    }

    async function saveMatrixToFirebase() {
        if (!isAuthReady || !userId) {
            showAlert('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.');
            return;
        }
        const matrixName = document.getElementById('matrixNameInput').value.trim();
        if (!matrixName) {
            showAlert('Vui l√≤ng nh·∫≠p t√™n ma tr·∫≠n.');
            return;
        }

        const saveBtn = document.getElementById('saveFirebaseBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang l∆∞u...';

        const collectionPath = `artifacts/${appId}/public/data/matrices`; // THAY ƒê·ªîI: Quay l·∫°i ƒë∆∞·ªùng d·∫´n c√¥ng khai
        const dataToSave = {
            name: matrixName,
            topics: topics,
            matrixData: matrixData,
            scoreSettings: scoreSettings,
            createdAt: serverTimestamp(),
            ownerId: userId // TH√äM M·ªöI: L∆∞u ID ch·ªß s·ªü h·ªØu
        };

        try {
            await addDoc(collection(db, collectionPath), dataToSave);
            closeSaveFirebaseModal();
            showSuccessMessage('ƒê√£ l∆∞u ma tr·∫≠n l√™n Cloud th√†nh c√¥ng!');
        } catch (err) {
            console.error('L·ªói khi l∆∞u v√†o Firestore:', err);
            showAlert(`L·ªói khi l∆∞u: ${err.message}`);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'L∆∞u';
        }
    }

    function closeLoadFirebaseModal() {
        document.getElementById('loadFirebaseModal').classList.add('hidden');
    }

    async function openLoadFirebaseModal() {
        if (!isAuthReady || !userId) {
            showAlert('Ch∆∞a s·∫µn s√†ng k·∫øt n·ªëi Cloud. Vui l√≤ng ƒë·ª£i m·ªôt l√°t v√† th·ª≠ l·∫°i.');
            return;
        }
        const modal = document.getElementById('loadFirebaseModal');
        const listContainer = document.getElementById('firebaseMatrixList');
        modal.classList.remove('hidden');
        listContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-2xl text-primary"></i><p class="mt-2">ƒêang t·∫£i danh s√°ch ma tr·∫≠n...</p></div>';

        const collectionPath = `artifacts/${appId}/public/data/matrices`; // THAY ƒê·ªîI: Quay l·∫°i ƒë∆∞·ªùng d·∫´n c√¥ng khai
        
        try {
            const q = query(collection(db, collectionPath)); // Kh√¥ng d√πng orderBy theo h∆∞·ªõng d·∫´n
            const querySnapshot = await getDocs(q);
            let matrices = [];
            querySnapshot.forEach((doc) => {
                matrices.push({ id: doc.id, ...doc.data() });
            });

            // S·∫Øp x·∫øp trong b·ªô nh·ªõ
            matrices.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : 0;
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : 0;
                return dateB - dateA; // M·ªõi nh·∫•t tr∆∞·ªõc
            });

            if (matrices.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">B·∫°n ch∆∞a l∆∞u ma tr·∫≠n n√†o l√™n Cloud.</p>';
                return;
            }

            listContainer.innerHTML = matrices.map(matrix => { // THAY ƒê·ªîI: C·∫≠p nh·∫≠t logic hi·ªÉn th·ªã
                const isOwner = matrix.ownerId === userId;
                const isAdmin = ADMIN_USER_IDS.includes(userId);
                const canDelete = isOwner || isAdmin;
                return `
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <div>
                        <span class="font-medium">${escapeHTML(matrix.name)}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400 block">
                            L∆∞u l√∫c: ${matrix.createdAt ? new Date(matrix.createdAt.toMillis()).toLocaleString('vi-VN') : 'Kh√¥ng r√µ'}
                        </span>
                        <span class="text-xs text-gray-500 dark:text-gray-400 block" title="User ID c·ªßa ng∆∞·ªùi t·∫°o">
                            L∆∞u b·ªüi: ${matrix.ownerId ? escapeHTML(matrix.ownerId) : 'Kh√¥ng r√µ'}
                        </span>
                    </div>
                    <div class="space-x-2 flex-shrink-0">
                        <button onclick="loadMatrixFromFirebase('${matrix.id}')" class="btn-primary py-1 px-3 text-sm">
                            <i class="fas fa-folder-open mr-1"></i>M·ªü
                        </button>
                        <button onclick="deleteMatrixFromFirebase('${matrix.id}', '${escapeHTML(matrix.name)}', this)" class="btn-danger py-1 px-3 text-sm ${!canDelete ? 'opacity-50 cursor-not-allowed' : ''}" ${!canDelete ? 'disabled title="Ch·ªâ ch·ªß s·ªü h·ªØu ho·∫∑c admin m·ªõi c√≥ th·ªÉ x√≥a"' : ''}>
                            <i class="fas fa-trash mr-1"></i>X√≥a
                        </button>
                    </div>
                </div>
            `}).join('');

        } catch (err) {
            console.error('L·ªói khi t·∫£i danh s√°ch t·ª´ Firestore:', err);
            listContainer.innerHTML = `<p class="text-center text-red-500 py-4">L·ªói khi t·∫£i danh s√°ch: ${err.message}</p>`;
        }
    }

    function loadMatrixFromFirebase(docId) {
        showConfirmDialog('M·ªü ma tr·∫≠n n√†y s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?', async () => {
            if (!isAuthReady || !userId) {
                showAlert('K·∫øt n·ªëi b·ªã gi√°n ƒëo·∫°n. Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }
            const docPath = `artifacts/${appId}/public/data/matrices/${docId}`; // THAY ƒê·ªîI: Quay l·∫°i ƒë∆∞·ªùng d·∫´n c√¥ng khai
            try {
                const docSnap = await getDoc(doc(db, docPath));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    topics = data.topics || [];
                    matrixData = data.matrixData || {};
                    scoreSettings = data.scoreSettings || { multipleChoice: 0.25, trueFalse: 1, essay: 1.0, percentages: { 'Nh·∫≠n bi·∫øt': 40, 'Th√¥ng hi·ªÉu': 30, 'V·∫≠n d·ª•ng': 30, 'V·∫≠n d·ª•ng cao': 0 } };
                    
                    renderTopics();
                    renderMatrix();
                    updateSummaryTable();
                    closeLoadFirebaseModal();
                    showSuccessMessage(`ƒê√£ t·∫£i ma tr·∫≠n "${data.name}" th√†nh c√¥ng!`);
                } else {
                    showAlert('Kh√¥ng t√¨m th·∫•y ma tr·∫≠n n√†y.');
                }
            } catch (err) {
                console.error('L·ªói khi t·∫£i ma tr·∫≠n:', err);
                showAlert(`L·ªói khi t·∫£i ma tr·∫≠n: ${err.message}`);
            }
        });
    }

    async function deleteMatrixFromFirebase(docId, matrixName, buttonElement) { // THAY ƒê·ªîI: C·∫≠p nh·∫≠t to√†n b·ªô h√†m
         showConfirmDialog(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ma tr·∫≠n "${matrixName}"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`, async () => {
            if (!isAuthReady || !userId) {
                showAlert('K·∫øt n·ªëi b·ªã gi√°n ƒëo·∫°n. Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }
            const docPath = `artifacts/${appId}/public/data/matrices/${docId}`; // THAY ƒê·ªîI: Quay l·∫°i ƒë∆∞·ªùng d·∫´n c√¥ng khai
            const docRef = doc(db, docPath);
            
            // V√¥ hi·ªáu h√≥a n√∫t
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y ma tr·∫≠n n√†y.");
                }

                const isAdmin = ADMIN_USER_IDS.includes(userId);
                if (docSnap.data().ownerId !== userId && !isAdmin) {
                    showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a ma tr·∫≠n n√†y. Ch·ªâ ch·ªß s·ªü h·ªØu ho·∫∑c admin m·ªõi c√≥ th·ªÉ x√≥a.');
                    throw new Error("Kh√¥ng c√≥ quy·ªÅn x√≥a.");
                }

                await deleteDoc(docRef);
                // X√≥a ph·∫ßn t·ª≠ kh·ªèi DOM
                buttonElement.closest('.flex.justify-between').remove();
                showSuccessMessage(`ƒê√£ x√≥a ma tr·∫≠n "${matrixName}".`);
            } catch (err) {
                console.error('L·ªói khi x√≥a ma tr·∫≠n:', err);
                if (err.message !== "Kh√¥ng c√≥ quy·ªÅn x√≥a.") {
                     showAlert(`L·ªói khi x√≥a: ${err.message}`);
                }
                // K√≠ch ho·∫°t l·∫°i n√∫t n·∫øu l·ªói
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<i class="fas fa-trash mr-1"></i>X√≥a';
            }
        });
    }
    // --- End Firebase Functions ---


    // Topic management
    function showTopicModal() {
        document.getElementById('topicModal').classList.remove('hidden');
        document.getElementById('topicNameInput').focus();
    }

    function closeTopicModal() {
        document.getElementById('topicModal').classList.add('hidden');
        document.getElementById('topicNameInput').value = '';
    }

    function addTopic() {
        const input = document.getElementById('topicNameInput');
        const topicName = input.value.trim();
        if (!topicName) {
            showAlert('Vui l√≤ng nh·∫≠p t√™n ch·ªß ƒë·ªÅ');
            return;
        }
        if (topics.includes(topicName)) {
            showAlert('Ch·ªß ƒë·ªÅ ƒë√£ t·ªìn t·∫°i');
            return;
        }
        topics.push(topicName);
        renderTopics();
        renderMatrix();
        updateSummaryTable();
        closeTopicModal();
        showSuccessMessage('ƒê√£ th√™m ch·ªß ƒë·ªÅ th√†nh c√¥ng!');
    }

    function removeTopic(index) {
        showConfirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ªß ƒë·ªÅ n√†y?', () => {
            const topicName = topics[index];
            topics.splice(index, 1);
            Object.keys(matrixData).forEach(key => {
                if (key.startsWith(topicName + '_')) {
                    delete matrixData[key];
                }
            });
            renderTopics();
            renderMatrix();
            updateSummaryTable();
            showSuccessMessage('ƒê√£ x√≥a ch·ªß ƒë·ªÅ th√†nh c√¥ng!');
        });
    }

    function renderTopics() {
        const container = document.getElementById('topicsList');
        if (topics.length === 0) {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Ch∆∞a c√≥ ch·ªß ƒë·ªÅ n√†o. Nh·∫•n "Th√™m Ch·ªß ƒë·ªÅ" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>';
            return;
        }
        container.innerHTML = topics.map((topic, index) => `
    <div class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full flex items-center space-x-2">
    <span>${escapeHTML(topic)}</span>
    <button onclick="removeTopic(${index})" class="text-blue-600 dark:text-blue-400 hover:text-red-500">
    <i class="fas fa-times text-sm"></i>
    </button>
    </div>
    `).join('');
    }

    // Matrix management
    function renderMatrix() {
        const container = document.getElementById('matrixGrid');
        if (topics.length === 0) {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-8">Th√™m ch·ªß ƒë·ªÅ ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫°o ma tr·∫≠n</p>';
            return;
        }
        const cols = taxonomyLevels.length + 1;
        container.style.gridTemplateColumns = `repeat(${cols}, minmax(120px, 1fr))`;
        let html = '';
        html += '<div class="font-bold text-center p-3 bg-gray-100 dark:bg-gray-700 rounded">Ch·ªß ƒë·ªÅ / M·ª©c ƒë·ªô</div>';
        taxonomyLevels.forEach(level => {
            html += `<div class="font-bold text-center p-3 bg-gray-100 dark:bg-gray-700 rounded">${level}</div>`;
        });
        topics.forEach(topic => {
            html += `<div class="font-medium p-3 bg-gray-50 dark:bg-gray-600 rounded flex items-center justify-center text-center">${escapeHTML(topic)}</div>`;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey] || { count: 0, notes: '' };
                const isFilled = cellData.count > 0;
                const questionTypes = [];
                if (cellData.multipleChoice > 0) questionTypes.push(`TN: ${cellData.multipleChoice}`);
                if (cellData.trueFalse > 0) questionTypes.push(`ƒê/S: ${cellData.trueFalse}`);
                if (cellData.essay > 0) questionTypes.push(`TL: ${cellData.essay}`);
                html += `
            <div class="matrix-cell ${isFilled ? 'filled' : ''} p-2 rounded cursor-pointer text-center flex flex-col justify-center"
                 onclick="openCellModal('${topic}', '${level}')">
                <div class="font-bold text-lg mb-1">${cellData.count || 0}</div>
                ${questionTypes.length > 0 ?
                    `<div class="text-xs space-y-1">${questionTypes.map(type => `<div class="bg-white dark:bg-gray-600 rounded px-1 py-0.5">${type}</div>`).join('')}</div>` : ''
                }
                ${cellData.notes ? '<div class="text-xs text-gray-600 dark:text-gray-400 mt-1 truncate" title="C√≥ ghi ch√∫">üìù</div>' : ''}
            </div>
            `;
            });
        });
        container.innerHTML = html;
    }

    function openCellModal(topic, level) {
        currentCell = { topic, level };
        const cellKey = `${topic}_${level}`;
        const cellData = matrixData[cellKey] || { multipleChoice: 0, trueFalse: 0, essay: 0, notes: '' };
        document.getElementById('cellModalTitle').textContent = `${topic} - ${level}`;
        document.getElementById('multipleChoiceCount').value = cellData.multipleChoice || 0;
        document.getElementById('trueFalseCount').value = cellData.trueFalse || 0;
        document.getElementById('essayCount').value = cellData.essay || 0;
        document.getElementById('cellNotes').value = cellData.notes || '';
        document.getElementById('questionPosition').value = cellData.position || '';
        document.getElementById('cellModal').classList.remove('hidden');
        document.getElementById('multipleChoiceCount').focus();
        updateTotalQuestionsInModal();
    }

    function closeCellModal() {
        document.getElementById('cellModal').classList.add('hidden');
        currentCell = null;
    }

    function saveCellData() {
        if (!currentCell) return;
        const newData = {
            multipleChoice: parseInt(document.getElementById('multipleChoiceCount').value) || 0,
            trueFalse: parseInt(document.getElementById('trueFalseCount').value) || 0,
            essay: parseInt(document.getElementById('essayCount').value) || 0,
            notes: document.getElementById('cellNotes').value.trim(),
            position: document.getElementById('questionPosition').value.trim(),
        };
        newData.count = newData.multipleChoice + newData.trueFalse + newData.essay;
        const cellKey = `${currentCell.topic}_${currentCell.level}`;
        const performSave = () => {
            if (newData.count === 0 && !newData.notes && !newData.position) {
                delete matrixData[cellKey];
            } else {
                matrixData[cellKey] = newData;
            }
            renderMatrix();
            updateSummaryTable();
            closeCellModal();
            showSuccessMessage('ƒê√£ l∆∞u d·ªØ li·ªáu √¥ ma tr·∫≠n!');
        };
        const tempMatrixData = JSON.parse(JSON.stringify(matrixData));
        if (newData.count === 0) {
            delete tempMatrixData[cellKey];
        } else {
            tempMatrixData[cellKey] = {
                multipleChoice: newData.multipleChoice,
                trueFalse: newData.trueFalse,
                essay: newData.essay
            };
        }
        const { grandTotalScore: projectedTotalScore, levelScores: projectedLevelScores } = calculateScores(tempMatrixData, scoreSettings);
        let deviationMessage = '';
        const TOLERANCE = 10.0;
        if (projectedTotalScore > 0) {
            taxonomyLevels.forEach(level => {
                const projectedPercentage = (projectedLevelScores[level] / projectedTotalScore) * 100;
                const targetPercentage = scoreSettings.percentages[level];
                if (Math.abs(projectedPercentage - targetPercentage) > TOLERANCE) {
                    deviationMessage += `\n- M·ª©c ƒë·ªô "${level}" s·∫Ω l√† ${projectedPercentage.toFixed(1)}% (m·ª•c ti√™u l√† ${targetPercentage}%).`;
                }
            });
        }
        if (deviationMessage) {
            const fullMessage = `L∆∞u thay ƒë·ªïi n√†y s·∫Ω khi·∫øn t·ªâ l·ªá ƒëi·ªÉm kh√°c bi·ªát ƒë√°ng k·ªÉ so v·ªõi m·ª•c ti√™u:` + deviationMessage + `\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c l∆∞u kh√¥ng?`;
            showConfirmDialog(fullMessage, performSave);
        } else {
            performSave();
        }
    }
    
    function calculateScores(data, settings) {
        const levelScores = {};
        taxonomyLevels.forEach(level => levelScores[level] = 0);
        topics.forEach(topic => {
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = data[cellKey];
                if (cellData) {
                    let cellScore = 0;
                    cellScore += (cellData.multipleChoice || 0) * settings.multipleChoice;
                    cellScore += (cellData.trueFalse || 0) * settings.trueFalse;
                    cellScore += (cellData.essay || 0) * settings.essay;
                    levelScores[level] += cellScore;
                }
            });
        });
        const grandTotalScore = Object.values(levelScores).reduce((sum, score) => sum + score, 0);
        return { grandTotalScore, levelScores };
    }

    function updateSummaryTable() {
        const tbody = document.getElementById('summaryTableBody');
        let html = '';
        document.getElementById('knowledgePercent').textContent = `(${scoreSettings.percentages['Nh·∫≠n bi·∫øt']}%)`;
        document.getElementById('comprehensionPercent').textContent = `(${scoreSettings.percentages['Th√¥ng hi·ªÉu']}%)`;
        document.getElementById('applicationPercent').textContent = `(${scoreSettings.percentages['V·∫≠n d·ª•ng']}%)`;
        topics.forEach(topic => {
            const counts = taxonomyLevels.map(level => {
                const cellKey = `${topic}_${level}`;
                return matrixData[cellKey]?.count || 0;
            });
            const total = counts.reduce((sum, count) => sum + count, 0);
            let topicScore = 0;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData) {
                    topicScore += (cellData.multipleChoice || 0) * scoreSettings.multipleChoice;
                    topicScore += (cellData.trueFalse || 0) * scoreSettings.trueFalse;
                    topicScore += (cellData.essay || 0) * scoreSettings.essay;
                }
            });
            html += `
        <tr>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 font-medium">${escapeHTML(topic)}</td>
            ${counts.map(count => `<td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">${count}</td>`).join('')}
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center font-bold">${total}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center font-bold text-blue-600 dark:text-blue-400">${topicScore.toFixed(2)}</td>
        </tr>
        `;
        });
        const totalCounts = taxonomyLevels.map(level => {
            return topics.reduce((sum, topic) => {
                const cellKey = `${topic}_${level}`;
                return sum + (matrixData[cellKey]?.count || 0);
            }, 0);
        });
        const { grandTotalScore, levelScores } = calculateScores(matrixData, scoreSettings);
        const levelScoresArray = taxonomyLevels.map(level => levelScores[level]);
        const grandTotalQuestions = totalCounts.reduce((sum, count) => sum + count, 0);
        const actualScorePercentages = levelScoresArray.map(score => {
            return grandTotalScore > 0 ? ((score / grandTotalScore) * 100).toFixed(1) : 0;
        });
        html += `
        <tr class="bg-gray-100 dark:bg-gray-700 font-bold">
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">T·ªïng c·ªông</td>
            ${totalCounts.map((count, index) => `
                <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                    ${count} c√¢u<br>
                    <span class="font-normal">${levelScoresArray[index].toFixed(2)} ƒëi·ªÉm</span><br>
                    <span class="text-xs text-green-600 dark:text-green-400 font-bold">(${actualScorePercentages[index]}%)</span>
                </td>
            `).join('')}
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">${grandTotalQuestions}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center text-green-600 dark:text-green-400">${grandTotalScore.toFixed(2)}</td>
        </tr>
        `;
        tbody.innerHTML = html;
    }

    // --- Specification Library Functions ---
    function openSpecificationModal() {
        document.getElementById('specificationModal').classList.remove('hidden');
        renderSpecificationLibrary();
    }

    function closeSpecificationModal() {
        document.getElementById('specificationModal').classList.add('hidden');
    }

    function loadSpecificationLibrary() {
        const savedLibrary = localStorage.getItem('specificationLibrary');
        if (savedLibrary) {
            specificationLibrary = JSON.parse(savedLibrary);
        }
    }

    function saveSpecificationLibrary() {
        localStorage.setItem('specificationLibrary', JSON.stringify(specificationLibrary));
    }

    function importFromDocx() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.docx';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                    .then(result => {
                        const text = result.value;
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        let newItemsCount = 0;
                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (trimmedLine && !specificationLibrary.includes(trimmedLine)) {
                                specificationLibrary.push(trimmedLine);
                                newItemsCount++;
                            }
                        });
                        
                        saveSpecificationLibrary();
                        renderSpecificationLibrary();
                        showSuccessMessage(`ƒê√£ nh·∫≠p v√† th√™m m·ªõi ${newItemsCount} m·ª•c t·ª´ file DOCX.`);
                    })
                    .catch(err => {
                        showAlert('L·ªói khi ƒë·ªçc file DOCX: ' + err.message);
                        console.error(err);
                    });
            };
            reader.readAsArrayBuffer(file);
        };
        input.click();
    }

    function renderSpecificationLibrary(filter = '') {
        const list = document.getElementById('specificationList');
        const filteredLibrary = specificationLibrary.filter(item => 
            item.toLowerCase().includes(filter.toLowerCase())
        );

        if (filteredLibrary.length === 0) {
            list.innerHTML = `<li class="text-center text-gray-500 dark:text-gray-400 py-4">Th∆∞ vi·ªán tr·ªëng. H√£y nh·∫≠p t·ª´ file DOCX.</li>`;
            return;
        }

        list.innerHTML = filteredLibrary.map((item) => {
            const originalIndex = specificationLibrary.findIndex(orig => orig === item);
            return `
                <li class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex items-center justify-between gap-2">
                    <span class="flex-grow text-sm">${escapeHTML(item)}</span>
                    <div class="flex-shrink-0 flex gap-2">
                        <button onclick="selectSpecification(${originalIndex})" class="text-green-500 hover:text-green-700" title="Ch·ªçn">
                            <i class="fas fa-check-circle"></i>
                        </button>
                        <button onclick="deleteSpecification(${originalIndex})" class="text-red-500 hover:text-red-700" title="X√≥a">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </li>
            `;
        }).join('');
    }

    function selectSpecification(index) {
        const notesTextarea = document.getElementById('cellNotes');
        const selectedItem = specificationLibrary[index];
        // Append with a new line if there's existing text
        if (notesTextarea.value.trim().length > 0) {
            notesTextarea.value += '\n' + selectedItem;
        } else {
            notesTextarea.value = selectedItem;
        }
        closeSpecificationModal();
    }

    function deleteSpecification(index) {
        showConfirmDialog(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a y√™u c·∫ßu "${specificationLibrary[index].substring(0, 30)}..."?`, () => {
            specificationLibrary.splice(index, 1);
            saveSpecificationLibrary();
            renderSpecificationLibrary();
        });
    }

    function searchSpecifications() {
        const searchTerm = document.getElementById('specificationSearch').value;
        renderSpecificationLibrary(searchTerm);
    }
    
    function clearLibrary() {
        showConfirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô th∆∞ vi·ªán ƒë·∫∑c t·∫£ kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.', () => {
            specificationLibrary = [];
            saveSpecificationLibrary();
            renderSpecificationLibrary();
            showSuccessMessage('ƒê√£ x√≥a to√†n b·ªô th∆∞ vi·ªán.');
        });
    }
    
    // AI Integration
    async function generateAITest() {
        const totalQuestions = Object.values(matrixData).reduce((sum, cell) => sum + (cell.count || 0), 0);
        if (totalQuestions === 0) {
            showAlert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi v√†o ma tr·∫≠n tr∆∞·ªõc khi t·∫°o ƒë·ªÅ thi b·∫±ng AI');
            return;
        }
        document.getElementById('aiModal').classList.remove('hidden');
        document.getElementById('aiLoadingState').classList.remove('hidden');
        document.getElementById('aiContent').classList.add('hidden');
        const matrixSummary = generateMatrixSummary();
        const apiKey = "AIzaSyCaUvSJx7Zn_qmYXdqlynADWR9YpcaxmSs";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;
        const prompt = `L√†m ∆°n t·∫°o m·ªôt ƒë·ªÅ ki·ªÉm tra ho√†n ch·ªânh d·ª±a tr√™n ma tr·∫≠n v√† c√°c th√¥ng tin chi ti·∫øt d∆∞·ªõi ƒë√¢y:

	${matrixSummary}

	Y√™u c·∫ßu c·ª• th·ªÉ:
	1.  **S·ªë l∆∞·ª£ng v√† lo·∫°i c√¢u h·ªèi:** T·∫°o ch√≠nh x√°c s·ªë l∆∞·ª£ng c√¢u h·ªèi cho m·ªói lo·∫°i (Tr·∫Øc nghi·ªám 4 ƒë√°p √°n, ƒê√∫ng/Sai, T·ª± lu·∫≠n) theo t·ª´ng ch·ªß ƒë·ªÅ v√† m·ª©c ƒë·ªô ƒë√£ quy ƒë·ªãnh trong ma tr·∫≠n.
	2.  **M·ª©c ƒë·ªô nh·∫≠n th·ª©c:** C√¢u h·ªèi ph·∫£i ph·∫£n √°nh ƒë√∫ng m·ª©c ƒë·ªô y√™u c·∫ßu (Nh·∫≠n bi·∫øt, Th√¥ng hi·ªÉu, V·∫≠n d·ª•ng).
    	* **Nh·∫≠n bi·∫øt:** C√¢u h·ªèi y√™u c·∫ßu nh·ªõ l·∫°i, nh·∫≠n d·∫°ng th√¥ng tin.
    	* **Th√¥ng hi·ªÉu:** C√¢u h·ªèi y√™u c·∫ßu gi·∫£i th√≠ch, so s√°nh, t√≥m t·∫Øt.
    	* **V·∫≠n d·ª•ng:** C√¢u h·ªèi y√™u c·∫ßu √°p d·ª•ng ki·∫øn th·ª©c v√†o t√¨nh hu·ªëng m·ªõi, gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ.
	3.  **N·ªôi dung:** B√°m s√°t v√†o t√™n ch·ªß ƒë·ªÅ v√† c√°c ghi ch√∫ (n·∫øu c√≥) ƒë·ªÉ t·∫°o c√¢u h·ªèi ph√π h·ª£p.
	4.  **ƒê√°p √°n:** Cung c·∫•p ƒë√°p √°n ƒë·∫ßy ƒë·ªß v√† chi ti·∫øt ngay sau ph·∫ßn ƒë·ªÅ thi. ƒê·ªëi v·ªõi c√¢u tr·∫Øc nghi·ªám, ch·ªâ r√µ ƒë√°p √°n ƒë√∫ng. ƒê·ªëi v·ªõi t·ª± lu·∫≠n, ƒë∆∞a ra g·ª£i √Ω tr·∫£ l·ªùi ho·∫∑c d√†n √Ω chi ti·∫øt.
	5.  **ƒê·ªãnh d·∫°ng:** Tr√¨nh b√†y ƒë·ªÅ thi v√† ƒë√°p √°n m·ªôt c√°ch chuy√™n nghi·ªáp, s·∫°ch s·∫Ω b·∫±ng c√°ch s·ª≠ d·ª•ng Markdown. Ph√¢n chia r√µ r√†ng c√°c ph·∫ßn: "ƒê·ªÄ KI·ªÇM TRA" v√† "ƒê√ÅP √ÅN V√Ä H∆Ø·ªöNG D·∫™N CH·∫§M".

	H√£y b·∫Øt ƒë·∫ßu t·∫°o ƒë·ªÅ thi.`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `L·ªói API: ${response.status}`);
            }
            const result = await response.json();
            const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (generatedText) {
                document.getElementById('aiLoadingState').classList.add('hidden');
                document.getElementById('aiContent').classList.remove('hidden');
                document.getElementById('aiGeneratedTest').innerHTML = marked.parse(generatedText);
            } else {
                throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung t·ª´ AI.");
            }
        } catch (err) {
            console.error('L·ªói g·ªçi API Gemini:', err);
            document.getElementById('aiLoadingState').classList.add('hidden');
            document.getElementById('aiContent').classList.remove('hidden');
            document.getElementById('aiGeneratedTest').innerHTML = `<div class="p-4 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg"><strong>L·ªói:</strong> ${err.message}. Vui l√≤ng th·ª≠ l·∫°i.</div>`;
        }
    }

    function generateMatrixSummary() {
        let summary = "MA TR·∫¨N ƒê·ªÄ KI·ªÇM TRA\n\n";
        summary += `**I. THI·∫æT L·∫¨P ƒêI·ªÇM S·ªê:**\n`;
        summary += `- Tr·∫Øc nghi·ªám 4 ƒë√°p √°n: ${scoreSettings.multipleChoice} ƒëi·ªÉm/c√¢u\n`;
        summary += `- ƒê√∫ng/Sai (4 √Ω): ${scoreSettings.trueFalse} ƒëi·ªÉm/c√¢u\n`;
        summary += `- T·ª± lu·∫≠n: ${scoreSettings.essay} ƒëi·ªÉm/c√¢u\n\n`;
        summary += `**II. T·ªà L·ªÜ M·ª®C ƒê·ªò MONG MU·ªêN:**\n`;
        taxonomyLevels.forEach(level => {
            if(scoreSettings.percentages[level]) {
                summary += `- ${level}: ${scoreSettings.percentages[level]}%\n`;
            }
        });
        summary += `\n**III. MA TR·∫¨N CHI TI·∫æT:**\n\n`;
        topics.forEach(topic => {
            summary += `**Ch·ªß ƒë·ªÅ: ${topic}**\n`;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData && cellData.count > 0) {
                    summary += `- **${level}:**\n`;
                    if (cellData.multipleChoice > 0) summary += `  - Tr·∫Øc nghi·ªám 4 ƒë√°p √°n: ${cellData.multipleChoice} c√¢u\n`;
                    if (cellData.trueFalse > 0) summary += `  - ƒê√∫ng/Sai: ${cellData.trueFalse} c√¢u (m·ªói c√¢u 4 √Ω)\n`;
                    if (cellData.essay > 0) summary += `  - T·ª± lu·∫≠n: ${cellData.essay} c√¢u\n`;
                    if (cellData.position) summary += `  - V·ªã tr√≠ g·ª£i √Ω trong ƒë·ªÅ: ${cellData.position}\n`;
                    if (cellData.notes) summary += `  - Ghi ch√∫/Y√™u c·∫ßu c·∫ßn ƒë·∫°t: ${cellData.notes}\n`;
                }
            });
            summary += `\n`;
        });
        return summary;
    }

    function regenerateTest() { generateAITest(); }
    function closeAIModal() { document.getElementById('aiModal').classList.add('hidden'); }

    // Export/Import functions
    function exportMatrix() {
        const data = { topics, matrixData, scoreSettings, timestamp: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ma-tran-de-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showSuccessMessage('ƒê√£ xu·∫•t ma tr·∫≠n th√†nh c√¥ng!');
    }

    function importMatrix() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.topics && data.matrixData && data.scoreSettings) {
                        topics = data.topics;
                        matrixData = data.matrixData;
                        scoreSettings = data.scoreSettings;
                        renderTopics();
                        renderMatrix();
                        updateSummaryTable();
                        showSuccessMessage('ƒê√£ nh·∫≠p ma tr·∫≠n th√†nh c√¥ng!');
                    } else { showAlert('File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.'); }
                } catch (err) { showAlert('L·ªói ƒë·ªçc file: ' + err.message); }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function exportTest() {
        const testContent = document.getElementById('aiGeneratedTest').innerHTML;
        const blob = new Blob([testContent], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `de-thi-${new Date().toISOString().split('T')[0]}.html`;
        a.click();
        URL.revokeObjectURL(url);
        showSuccessMessage('ƒê√£ xu·∫•t ƒë·ªÅ thi th√†nh c√¥ng!');
    }
    
    function exportExcel() {
        if (topics.length === 0) {
            showAlert('Ch∆∞a c√≥ d·ªØ li·ªáu ma tr·∫≠n ƒë·ªÉ xu·∫•t file Excel.');
            return;
        }

        const wb = XLSX.utils.book_new();

        // --- Sheet 1: MA TR·∫¨N ---
        const matrix_ws_data = [
            ["TT", "Ch∆∞∆°ng/ ch·ªß ƒë·ªÅ", "N·ªôi dung/ƒë∆°n v·ªã ki·∫øn th·ª©c", "M·ª©c ƒë·ªô ƒë√°nh gi√°", null, null, null, null, null, null, null, null, null, "T·ªïng", "T·ªâ l·ªá % ƒëi·ªÉm"],
            [null, null, null, "TNKQ", null, null, null, null, "T·ª± lu·∫≠n", null, null, null, null, null, null],
            [null, null, null, "Nhi·ªÅu l·ª±a ch·ªçn", null, null, "ƒê√∫ng - Sai", null, null, null, null, null, null, null, null],
            [null, null, null, "Bi·∫øt", "Hi·ªÉu", "VD", "Bi·∫øt", "Hi·ªÉu", "VD", "Bi·∫øt", "Hi·ªÉu", "VD", null, null, null]
        ];

        let grandTotalScore = 0;
        const levelTotals = {
            mc: { nb: 0, th: 0, vd: 0 },
            tf: { nb: 0, th: 0, vd: 0 },
            essay: { nb: 0, th: 0, vd: 0 }
        };
        const levelScoreTotals = { nb: 0, th: 0, vd: 0 };


        topics.forEach((topic, index) => {
            const row = Array(15).fill(null);
            row[0] = index + 1;
            row[1] = topic;
            let topicTotalScore = 0;
            let topicTotalQuestions = 0;

            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData) {
                    const mc = cellData.multipleChoice || 0;
                    const tf = cellData.trueFalse || 0;
                    const essay = cellData.essay || 0;
                    
                    topicTotalQuestions += (mc + tf + essay);
                    const cellScore = mc * scoreSettings.multipleChoice + tf * scoreSettings.trueFalse + essay * scoreSettings.essay;
                    topicTotalScore += cellScore;
                    
                    if (level === 'Nh·∫≠n bi·∫øt') {
                        row[3] = (row[3] || 0) + mc;
                        row[6] = (row[6] || 0) + tf;
                        row[9] = (row[9] || 0) + essay;
                        levelTotals.mc.nb += mc; levelTotals.tf.nb += tf; levelTotals.essay.nb += essay;
                        levelScoreTotals.nb += cellScore;
                    } else if (level === 'Th√¥ng hi·ªÉu') {
                        row[4] = (row[4] || 0) + mc;
                        row[7] = (row[7] || 0) + tf;
                        row[10] = (row[10] || 0) + essay;
                        levelTotals.mc.th += mc; levelTotals.tf.th += tf; levelTotals.essay.th += essay;
                        levelScoreTotals.th += cellScore;
                    } else if (level === 'V·∫≠n d·ª•ng' || level === 'V·∫≠n d·ª•ng cao') {
                        row[5] = (row[5] || 0) + mc;
                        row[8] = (row[8] || 0) + tf;
                        row[11] = (row[11] || 0) + essay;
                        levelTotals.mc.vd += mc; levelTotals.tf.vd += tf; levelTotals.essay.vd += essay;
                        levelScoreTotals.vd += cellScore;
                    }
                }
            });
            row[13] = `${topicTotalQuestions} c√¢u\n${topicTotalScore.toFixed(2)} ƒëi·ªÉm`;
            grandTotalScore += topicTotalScore;
            matrix_ws_data.push(row);
        });

        // Calculate percentages for each topic
        matrix_ws_data.slice(4).forEach(row => {
            const topicScore = parseFloat(row[13].split('\n')[1]);
            row[14] = grandTotalScore > 0 ? ((topicScore / grandTotalScore) * 100).toFixed(1) + '%' : '0%';
        });


        // Total Row
        const totalRow = Array(15).fill(null);
        totalRow[1] = "T·ªïng s·ªë c√¢u";
        totalRow[3] = levelTotals.mc.nb; totalRow[4] = levelTotals.mc.th; totalRow[5] = levelTotals.mc.vd;
        totalRow[6] = levelTotals.tf.nb; totalRow[7] = levelTotals.tf.th; totalRow[8] = levelTotals.tf.vd;
        totalRow[9] = levelTotals.essay.nb; totalRow[10] = levelTotals.essay.th; totalRow[11] = levelTotals.essay.vd;
        const totalQ = Object.values(levelTotals).flatMap(o => Object.values(o)).reduce((a,b) => a+b, 0);
        totalRow[13] = totalQ;
        matrix_ws_data.push(totalRow);

        const totalScoreRow = Array(15).fill(null);
        totalScoreRow[1] = "T·ªïng s·ªë ƒëi·ªÉm";
        totalScoreRow[13] = grandTotalScore.toFixed(2);
        matrix_ws_data.push(totalScoreRow);

        const percentageRow = Array(15).fill(null);
        percentageRow[1] = "T·ªâ l·ªá %";
        percentageRow[13] = "100%";
        matrix_ws_data.push(percentageRow);


        const matrix_ws = XLSX.utils.aoa_to_sheet(matrix_ws_data, { cellStyles: true });
        matrix_ws['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 3, c: 0 } }, // TT
            { s: { r: 0, c: 1 }, e: { r: 3, c: 1 } }, // Ch·ªß ƒë·ªÅ
            { s: { r: 0, c: 2 }, e: { r: 3, c: 2 } }, // N·ªôi dung
            { s: { r: 0, c: 3 }, e: { r: 0, c: 12 } },// M·ª©c ƒë·ªô ƒë√°nh gi√°
            { s: { r: 0, c: 13 }, e: { r: 3, c: 13 } },// T·ªïng
            { s: { r: 0, c: 14 }, e: { r: 3, c: 14 } },// T·ªâ l·ªá
            { s: { r: 1, c: 3 }, e: { r: 1, c: 8 } }, // TNKQ
            { s: { r: 1, c: 9 }, e: { r: 1, c: 11 } }, // T·ª± lu·∫≠n
            { s: { r: 2, c: 3 }, e: { r: 2, c: 5 } }, // Nhi·ªÅu l·ª±a ch·ªçn
            { s: { r: 2, c: 6 }, e: { r: 2, c: 8 } }, // ƒê√∫ng sai
            { s: { r: 2, c: 9 }, e: { r: 2, c: 11 } }, // T·ª± lu·∫≠n (d√≤ng 3) - merged
        ];
        XLSX.utils.book_append_sheet(wb, matrix_ws, "MA TR·∫¨N");


        // --- Sheet 2: B·∫¢NG ƒê·∫∂C T·∫¢ ---
        const spec_ws_data = [
            ["TT", "Ch∆∞∆°ng/ ch·ªß ƒë·ªÅ", "N·ªôi dung/ ƒë∆°n v·ªã ki·∫øn th·ª©c", "Y√™u c·∫ßu c·∫ßn ƒë·∫°t", "C√¢u", "S·ªë c√¢u h·ªèi ·ªü c√°c m·ª©c ƒë·ªô ƒë√°nh gi√°", null, null, null, null, null, null, null, null],
            [null, null, null, null, null, "TNKQ", null, null, null, null, "T·ª± lu·∫≠n", null, null, null],
            [null, null, null, null, null, "Nhi·ªÅu l·ª±a ch·ªçn", null, null, "ƒê√∫ng - Sai", null, null, null, null, null],
            [null, null, null, null, null, "Bi·∫øt", "Hi·ªÉu", "VD", "Bi·∫øt", "Hi·ªÉu", "VD", "Bi·∫øt", "Hi·ªÉu", "VD"]
        ];

        let specCount = 1;
        topics.forEach(topic => {
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                
                if (cellData && cellData.count > 0 && cellData.notes) {
                    const notesArray = cellData.notes.split('\n').filter(n => n.trim() !== '');
                    notesArray.forEach(note => {
                        const row = Array(14).fill(null);
                        row[0] = specCount++;
                        row[1] = topic;
                        // row[2] is for content, can be filled later
                        row[3] = note;
                        row[4] = cellData.position || "";

                        let mc = cellData.multipleChoice || 0;
                        let tf = cellData.trueFalse || 0;
                        let essay = cellData.essay || 0;

                        if(notesArray.length > 1) {
                            mc = ''; tf = ''; essay = ''; // Avoid duplicating numbers if multiple notes in one cell
                        }

                        if (level === 'Nh·∫≠n bi·∫øt') {
                            row[5] = mc; row[8] = tf; row[11] = essay;
                        } else if (level === 'Th√¥ng hi·ªÉu') {
                            row[6] = mc; row[9] = tf; row[12] = essay;
                        } else if (level === 'V·∫≠n d·ª•ng' || level === 'V·∫≠n d·ª•ng cao') {
                            row[7] = mc; row[10] = tf; row[13] = essay;
                        }
                        spec_ws_data.push(row);
                    });
                }
            });
        });

        const spec_ws = XLSX.utils.aoa_to_sheet(spec_ws_data);
        spec_ws['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 3, c: 0 } }, // TT
            { s: { r: 0, c: 1 }, e: { r: 3, c: 1 } }, // Ch·ªß ƒë·ªÅ
            { s: { r: 0, c: 2 }, e: { r: 3, c: 2 } }, // N·ªôi dung
            { s: { r: 0, c: 3 }, e: { r: 3, c: 3 } }, // Y√™u c·∫ßu
            { s: { r: 0, c: 4 }, e: { r: 3, c: 4 } }, // C√¢u
            { s: { r: 0, c: 5 }, e: { r: 0, c: 13 } },// M·ª©c ƒë·ªô ƒë√°nh gi√°
            { s: { r: 1, c: 5 }, e: { r: 1, c: 10 } },// TNKQ
            { s: { r: 1, c: 11}, e: { r: 1, c: 13 } },// T·ª± lu·∫≠n
            { s: { r: 2, c: 5 }, e: { r: 2, c: 7 } }, // Nhi·ªÅu l·ª±a ch·ªçn
            { s: { r: 2, c: 8 }, e: { r: 2, c: 10 } },// ƒê√∫ng Sai
            { s: { r: 2, c: 11}, e: { r: 2, c: 13 } },// T·ª± lu·∫≠n (d√≤ng 3)
        ];
        XLSX.utils.book_append_sheet(wb, spec_ws, "B·∫¢NG ƒê·∫∂C T·∫¢");

        XLSX.writeFile(wb, `MaTranVaDacTa_${new Date().toISOString().split('T')[0]}.xlsx`);
        showSuccessMessage('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng theo m·∫´u DOCX!');
    }

    function clearAll() {
        showConfirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu?', () => {
            topics = [];
            matrixData = {};
            renderTopics();
            renderMatrix();
            updateSummaryTable();
            showSuccessMessage('ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!');
        });
    }

    // Utility functions
    function showAlert(message) {
        // X√≥a modal c≈© n·∫øu c√≥
        const oldModal = document.getElementById('alertModal');
        if (oldModal) oldModal.remove();
        
        const modal = document.createElement('div');
        modal.id = 'alertModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]';
        modal.innerHTML = `<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><h3 class="text-lg font-bold mb-4">Th√¥ng b√°o</h3><p>${message}</p><div class="flex justify-end mt-4"><button onclick="this.closest('.fixed').remove()" class="btn-primary">ƒê√≥ng</button></div></div>`;
        document.body.appendChild(modal);
    }

    function showConfirmDialog(message, onConfirm) {
        // X√≥a modal c≈© n·∫øu c√≥
        const oldModal = document.getElementById('confirmModal');
        if (oldModal) oldModal.remove();

        const modal = document.createElement('div');
        modal.id = 'confirmModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]';
        modal.innerHTML = `<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><h3 class="text-lg font-bold mb-4">X√°c nh·∫≠n</h3><p class="whitespace-pre-line">${message}</p><div class="flex justify-end mt-4 space-x-2"><button class="btn-outline" onclick="this.closest('.fixed').remove()">H·ªßy</button><button id="confirmBtn" class="btn-danger">X√°c nh·∫≠n</button></div></div>`;
        document.body.appendChild(modal);
        document.getElementById('confirmBtn').onclick = () => {
            modal.remove();
            onConfirm();
        };
    }

    function showSuccessMessage(message) {
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successModal').classList.remove('hidden');
    }

    function closeSuccessModal() {
        document.getElementById('successModal').classList.add('hidden');
    }

    function updateTotalQuestionsInModal() {
        const mc = parseInt(document.getElementById('multipleChoiceCount').value) || 0;
        const tf = parseInt(document.getElementById('trueFalseCount').value) || 0;
        const essay = parseInt(document.getElementById('essayCount').value) || 0;
        document.getElementById('totalQuestions').textContent = mc + tf + essay;
        document.getElementById('totalScore').textContent = ((mc * scoreSettings.multipleChoice) + (tf * scoreSettings.trueFalse) + (essay * scoreSettings.essay)).toFixed(2);
    }

    // Score Settings Modal Functions
    function showScoreModal() {
        document.getElementById('scoreMultipleChoice').value = scoreSettings.multipleChoice;
        document.getElementById('scoreTrueFalse').value = scoreSettings.trueFalse;
        document.getElementById('scoreEssay').value = scoreSettings.essay;
        document.getElementById('percentKnowledge').value = scoreSettings.percentages['Nh·∫≠n bi·∫øt'];
        document.getElementById('percentComprehension').value = scoreSettings.percentages['Th√¥ng hi·ªÉu'];
        document.getElementById('percentApplication').value = scoreSettings.percentages['V·∫≠n d·ª•ng'];
        document.getElementById('scoreModal').classList.remove('hidden');
        updateScoreCalculationInModal();
        updatePercentageTotalInModal();
    }

    function closeScoreModal() {
        document.getElementById('scoreModal').classList.add('hidden');
    }

    function saveScoreSettings() {
        const pK = parseInt(document.getElementById('percentKnowledge').value) || 0;
        const pC = parseInt(document.getElementById('percentComprehension').value) || 0;
        const pA = parseInt(document.getElementById('percentApplication').value) || 0;
        if (pK + pC + pA !== 100) {
            showAlert('T·ªïng t·ªâ l·ªá c√°c m·ª©c ƒë·ªô ph·∫£i b·∫±ng 100%');
            return;
        }
        scoreSettings.multipleChoice = parseFloat(document.getElementById('scoreMultipleChoice').value) || 0.25;
        scoreSettings.trueFalse = parseFloat(document.getElementById('scoreTrueFalse').value) || 1;
        scoreSettings.essay = parseFloat(document.getElementById('scoreEssay').value) || 1.0;
        scoreSettings.percentages['Nh·∫≠n bi·∫øt'] = pK;
        scoreSettings.percentages['Th√¥ng hi·ªÉu'] = pC;
        scoreSettings.percentages['V·∫≠n d·ª•ng'] = pA;
        closeScoreModal();
        updateSummaryTable();
        showSuccessMessage('ƒê√£ l∆∞u thi·∫øt l·∫≠p ƒëi·ªÉm s·ªë th√†nh c√¥ng!');
    }

    function updateScoreCalculationInModal() {
        const mcScore = parseFloat(document.getElementById('scoreMultipleChoice').value) || 0;
        const tfScore = parseFloat(document.getElementById('scoreTrueFalse').value) || 0;
        const essayScore = parseFloat(document.getElementById('scoreEssay').value) || 0;
        let totalMC = 0, totalTF = 0, totalEssay = 0;
        Object.values(matrixData).forEach(cell => {
            totalMC += cell.multipleChoice || 0;
            totalTF += cell.trueFalse || 0;
            totalEssay += cell.essay || 0;
        });
        const totalScore = (totalMC * mcScore) + (totalTF * tfScore) + (totalEssay * essayScore);
        document.getElementById('scoreCalculation').innerHTML = `<div>T·ªïng ƒëi·ªÉm d·ª± ki·∫øn: ${totalScore.toFixed(2)} ƒëi·ªÉm</div>`;
    }

    function updatePercentageTotalInModal() {
        const total = (parseInt(document.getElementById('percentKnowledge').value) || 0) +
                      (parseInt(document.getElementById('percentComprehension').value) || 0) +
                      (parseInt(document.getElementById('percentApplication').value) || 0);
        const totalEl = document.getElementById('totalPercent');
        totalEl.textContent = `T·ªïng: ${total}%`;
        totalEl.classList.toggle('text-green-600', total === 100);
        totalEl.classList.toggle('dark:text-green-400', total === 100);
        totalEl.classList.toggle('text-red-600', total !== 100);
        totalEl.classList.toggle('dark:text-red-400', total !== 100);
    }
    
    function escapeHTML(str) {
        if (typeof str !== 'string') return str;
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            }[m];
        });
    }

    // --- EXPOSE FUNCTIONS TO GLOBAL SCOPE ---
    // G√°n c√°c h√†m v√†o 'window' ƒë·ªÉ HTML (onclick) c√≥ th·ªÉ truy c·∫≠p ch√∫ng
    Object.assign(window, {
        showTopicModal,
        showScoreModal,
        generateAITest,
        exportMatrix,
        exportExcel,
        importMatrix,
        showSaveFirebaseModal,
        openLoadFirebaseModal,
        clearAll,
        closeTopicModal,
        addTopic,
        removeTopic,
        openCellModal,
        closeCellModal,
        openSpecificationModal,
        saveCellData,
        closeAIModal,
        regenerateTest,
        exportTest,
        closeScoreModal,
        saveScoreSettings,
        closeSpecificationModal,
        importFromDocx,
        clearLibrary,
        searchSpecifications,
        selectSpecification,
        deleteSpecification,
        closeSuccessModal,
        closeSaveFirebaseModal,
        saveMatrixToFirebase,
        closeLoadFirebaseModal,
        loadMatrixFromFirebase,
        deleteMatrixFromFirebase,
        updateTotalQuestionsInModal,
        updateScoreCalculationInModal,
        updatePercentageTotalInModal
    });

</script>
</body>
</html>





